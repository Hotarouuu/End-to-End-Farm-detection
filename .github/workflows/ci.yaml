name: ci_pipe

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  black:
    name: Run black code formatter
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5 
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install black

      - name: Run black
        run: black .

  test:
    name: Run all tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install .

      - name: Run tests
        run: pytest

  build:
    name: Build and run Docker containers
    needs: [black, test] # Garante que o build s√≥ ocorra se o CI passar
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build and run Docker containers
        run: docker-compose -f compose.yaml up --build -d

      - name: Wait for containers
        run: sleep 15 

      - name: Check if API is running
        run: curl -f http://localhost:8000/ || exit 1

      - name: Check if MLflow is running
        run: curl -f http://localhost:5000/ || exit 1

      - name: Tear down
        if: always() # Garante que os containers parem mesmo se o curl falhar
        run: docker-compose -f compose.yaml down
